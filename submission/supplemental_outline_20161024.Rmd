---
title: ""
bibliography:
csl: mbio.csl
output: 
  pdf_document:
    keep_tex: true
fontsize: 12pt
geometry: margin=1.0in
---

# Differences in the Stool Microbiome Before and After Colorectal Cancer Treatment

\vspace{10mm}

\begin{center}
Marc A Sze, Nielson T Baxter, Mack T Ruffin IV, Mary AM Rogers, and Patrick D Schloss

\vspace{10mm}

Supplemental
\end{center}


\newpage

```{r knitr_settings, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

source('../code/functions.R')
source('../code/graphFunctions.R')

loadLibs(c("dplyr", "tidyr", "ggplot2", "reshape2", "gridExtra", "scales", "wesanderson", "knitr", "rmarkdown"))

```



**Table S1: P-values of Differences between Initial and Follow Up Samples for Richness, Shannon Diversity, and Evenness.**

```{r supplemental_table1, echo=FALSE, message=FALSE, warning=FALSE}

alpha_table <- read.csv("../results/tables/alpha_table_summary.csv", header = T, stringsAsFactors = F)
supplemental_table1 <- separate(alpha_table, X, c("comparison", "alpha_metric"), sep="_") 

colnames(supplemental_table1) <- c("Comparison", "Alpha Metric", "P-value", "BH Adjusted P-value")

kable(supplemental_table1, format = "markdown", align = 'c', padding = 2)
```


\newpage


**Table S2: Summary of Most Important Variables For the Model**

```{r supplemental_table2, echo=FALSE, message=FALSE, warning=FALSE}

imp_model_vars <- read.csv('../results/tables/rf_wCV_imp_vars_summary.csv', stringsAsFactors = F, header = T)
rf_otu_tax <- read.csv('../results/tables/rf_otu_tax.csv', stringsAsFactors = F, header = T, row.names = 1)
rf_otu_tax <- cbind(otu = rownames(rf_otu_tax), rf_otu_tax)

all_data <- full_join(imp_model_vars, rf_otu_tax, by = c("Variable" = "otu"))

imp_model_vars <- cbind(Variable = imp_model_vars$Variable, Tax = createTaxaLabeller(all_data), 
                        total_appearance = imp_model_vars$total_appearance)

colnames(imp_model_vars) <- c("Variable", "Lowest Taxonomic ID", "Total Model Appearances")

kable(imp_model_vars, format = "markdown", align = 'c', padding = 2)

```

\newpage


**Table S3: Summary of Probability Assignment of Follow Up Individuals**

```{r supplemental_table3, echo=FALSE, message=FALSE, warning=FALSE}

follow_up_prob_summary <- read.csv('../results/tables/follow_up_probability_summary.csv', stringsAsFactors = F, header = T)

st3 <- as.data.frame(filter(follow_up_prob_summary, sampleType == "initial")[, "Yes"]) %>% 
  mutate(follow_yes = filter(follow_up_prob_summary, sampleType == "followup")[, "Yes"]) %>% 
  mutate(disease_free = filter(follow_up_prob_summary, sampleType == "initial")[, "disease_free"]) %>% 
  mutate(diagnosis = filter(follow_up_prob_summary, sampleType == "initial")[, "Dx_Bin"])

st3$disease_free[st3$disease_free == "n"] <- "No"
st3$disease_free[st3$disease_free == "unknown"] <- "Unknown"
st3$disease_free[st3$disease_free == "y"] <- "Yes"

colnames(st3) <- c("Initial Positive Probability", "Follow Up Positive Probability", "Disease Free on Follow Up", "Initial Diagnosis")

kable(st3, format = "markdown", align = 'c', padding = 2)

```

\newpage


**Table S4: Summary of OTUs in both Lesion and Initial/Follow Up Models**

```{r supplemental_table4, echo=FALSE, message=FALSE, warning=FALSE}

pvalue_common_imp_vars <- read.csv('../results/tables/pvalue_common_imp_vars.csv', header = T, row.names = 1)

st4 <- select(pvalue_common_imp_vars, otu) %>% 
  mutate(Tax = createTaxaLabeller(select(pvalue_common_imp_vars, -Pvalue, -BH_corr))) %>% 
  mutate(Pvalue = pvalue_common_imp_vars$Pvalue) %>% 
  mutate(BH_corr = pvalue_common_imp_vars$BH_corr)

colnames(st4) <- c("OTU", "Lowest Taxonomic ID", "P-value", "BH Corrected P-value")

kable(st4, format = "markdown", align = 'c', padding = 2)

```


\newpage


**Table S5: Summary of P-values for Specific CRC OTUs between Initial and Follow Ups**

```{r supplemental_table5, echo=FALSE, message=FALSE, warning=FALSE}

pvalue_adn_crc_summary <- read.csv('../results/tables/adn_crc_maybe_pvalue_summary.csv', header = T, row.names = 1)

st5 <- cbind(tax_id = c("Fusobacterium Nucleatum", "Parvimonas Micra", 
                        "Peptostreptococcus Assacharolytica", "Porphyromonas Stomatis"), 
             crc_pvalue = format(pvalue_adn_crc_summary$crc_pvalue, digits = 3), 
             crc_bh = format(pvalue_adn_crc_summary$crc_BH, digits = 3), 
             adn_pvalue = format(pvalue_adn_crc_summary$adn_pvalue, digits = 3), 
             adn_bh = format(pvalue_adn_crc_summary$adn_BH, digits = 3))

colnames(st5) <- c("Taxonomic ID", "CRC P-value", "CRC BH Corrected P-value", 
                   "Adenoma P-value", "Adenoma BH Corrected P-value")

kable(st5, format = "markdown", align = 'c', padding = 2)

```






```{r supplemental_figure1, echo=FALSE, message=FALSE, warning=FALSE}

diff_table_time <- read.csv("../results/tables/time_datatable.csv", header = T)

# Plot the change in distance versus time
time_graph <- ggplot(diff_table_time, aes(x = time, y = distance)) + 
  geom_point(aes(color = dx), size = 4) + theme_bw() + 
  scale_color_manual(name = "Lesion Type", values = wes_palette("GrandBudapest"), 
                     breaks = c("adenoma", "cancer"), labels = c("Adenoma", "Cancer")) + 
  coord_cartesian(ylim = c(0, 1)) + ylab("Thetayc Distance") + xlab("Time from Initial (Days)") + 
  theme(axis.title = element_text(face="bold"), legend.title = element_text(face="bold"))

ggsave(file = "../results/figures/FigureS1.pdf", time_graph, 
       width=6, height = 8, dpi = 300)
```





